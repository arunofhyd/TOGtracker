<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOG Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        .input-field { transition: all 0.2s; }
        .input-field:focus { outline: none; }
        .btn-outline { transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .icon-btn { padding: 2px; border-radius: 4px; transition: all 0.2s; cursor: pointer; }
        
        /* Grid Layout: 8 Columns Fixed (7 Days + 1 Stat) */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(8, minmax(100px, 1fr)); 
            gap: 0.5rem;
        }

        .day-card { border-radius: 0.375rem; overflow: hidden; display: flex; flex-direction: column; min-height: 100px; }
        .stats-card { border-radius: 0.375rem; display: flex; flex-direction: column; justify-content: center; padding: 0.5rem; min-height: 100px; }

        .day-header { padding: 4px 6px; display: flex; justify-content: space-between; items-center; font-size: 0.75rem; }
        .day-body { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2px; }
        .day-footer { height: 24px; display: flex; align-items: center; justify-content: center; border-top-width: 1px; }

        #toast { visibility: hidden; min-width: 200px; text-align: center; border-radius: 6px; padding: 10px; position: fixed; z-index: 50; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 13px; font-weight: 500; opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }
        
        @media (max-width: 1024px) {
            .calendar-grid { min-width: 900px; } 
            .scroll-container { overflow-x: auto; padding-bottom: 10px; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-[1400px] space-y-6">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">TOG Tracker</h1>
                <p class="text-xs text-slate-500 dark:text-slate-400">Productivity & Time Converter</p>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="bg-white dark:bg-slate-900 px-3 py-1.5 rounded-md border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-2 transition-colors">
                    <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Memory</span>
                    <span id="globalMemory" class="font-mono font-bold text-blue-600 dark:text-blue-400 text-sm">0.0</span>
                </div>
                <button onclick="toggleTheme()" class="p-2 rounded-md bg-white border border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-900 dark:border-slate-800 dark:text-slate-400 dark:hover:bg-slate-800 transition-colors">
                    <i data-lucide="moon" class="w-4 h-4 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-4 h-4 block dark:hidden"></i>
                </button>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-white border border-slate-200 dark:bg-slate-900 dark:border-slate-800 p-4 rounded-xl flex items-center gap-4">
                <div class="min-w-[90px] text-xs font-bold uppercase text-slate-400">TIME TO TOG</div>
                <input type="number" id="c1_h" class="input-field w-16 bg-slate-50 border border-slate-200 text-slate-900 rounded p-1 text-center dark:bg-slate-950 dark:border-slate-700 dark:text-white" placeholder="H">
                <span class="text-slate-300">:</span>
                <input type="number" id="c1_m" class="input-field w-16 bg-slate-50 border border-slate-200 text-slate-900 rounded p-1 text-center dark:bg-slate-950 dark:border-slate-700 dark:text-white" placeholder="M">
                <div class="flex-1 text-right">
                    <span id="res_decimal" class="font-mono font-bold text-lg text-blue-600 dark:text-blue-400">0.0</span>
                </div>
            </div>

            <div class="bg-white border border-slate-200 dark:bg-slate-900 dark:border-slate-800 p-4 rounded-xl flex items-center gap-4">
                <div class="min-w-[90px] text-xs font-bold uppercase text-slate-400">TOG TO TIME</div>
                <input type="number" id="c2_d" class="input-field w-24 bg-slate-50 border border-slate-200 text-slate-900 rounded p-1 text-center dark:bg-slate-950 dark:border-slate-700 dark:text-white" placeholder="5.2">
                <div class="flex-1 text-right">
                    <span id="res_time" class="font-mono font-bold text-lg text-emerald-600 dark:text-emerald-400">0h 0m</span>
                </div>
            </div>
        </div>

        <div class="bg-white border border-slate-200 dark:bg-slate-900 dark:border-slate-800 p-6 rounded-xl shadow-sm">
            
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-2">
                    <button onclick="changeMonth(-1)" class="btn-outline border-slate-200 text-slate-700 bg-white hover:bg-slate-50 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 px-2 h-9"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <button onclick="goToToday()" class="btn-outline border-slate-200 text-slate-700 bg-white hover:bg-slate-50 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 text-sm h-9 font-bold w-32 justify-center">Today</button>
                    <button onclick="changeMonth(1)" class="btn-outline border-slate-200 text-slate-700 bg-white hover:bg-slate-50 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 px-2 h-9"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white ml-2" id="monthLabel">...</h2>
                </div>

                <div class="flex gap-6 justify-end bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-100 dark:border-slate-800">
                    <div class="text-right">
                        <span class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Total (View)</span>
                        <span id="monthTotal" class="text-2xl font-bold text-slate-900 dark:text-white leading-none">0.0</span>
                    </div>
                    <div class="text-right">
                        <span class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Avg (Active)</span>
                        <span id="monthAvg" class="text-2xl font-bold text-blue-600 dark:text-blue-400 leading-none">0.0</span>
                    </div>
                </div>
            </div>

            <div class="scroll-container">
                <div class="calendar-grid mb-2">
                    <div class="text-center text-xs font-bold text-slate-400 uppercase py-1">Mon</div>
                    <div class="text-center text-xs font-bold text-slate-400 uppercase py-1">Tue</div>
                    <div class="text-center text-xs font-bold text-slate-400 uppercase py-1">Wed</div>
                    <div class="text-center text-xs font-bold text-slate-400 uppercase py-1">Thu</div>
                    <div class="text-center text-xs font-bold text-slate-400 uppercase py-1">Fri</div>
                    <div class="text-center text-xs font-bold text-slate-400 uppercase py-1">Sat</div>
                    <div class="text-center text-xs font-bold text-slate-400 uppercase py-1">Sun</div>
                    <div class="text-center text-xs font-bold text-emerald-500 uppercase py-1 border-l border-slate-100 dark:border-slate-800">Weekly</div>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    </div>
            </div>

        </div>
    </div>

    <div id="toast" class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-lg">Notification</div>

    <script>
        function initTheme() {
            const userPref = localStorage.getItem('theme');
            const systemPref = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (userPref === 'dark' || (!userPref && systemPref)) { document.documentElement.classList.add('dark'); } 
            else { document.documentElement.classList.remove('dark'); }
        }
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.setItem('theme', 'light'); } 
            else { html.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
        }
        initTheme();
        
        lucide.createIcons();

        // --- VARS & STORAGE ---
        let viewDate = new Date(); 
        let lastCalculatedDecimal = 0.0;
        const STORAGE_KEY = 'tog_tracker_final_v8'; 
        let storedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

        function saveData(key, value) {
            // Treat empty string as "delete", but keep "0" as a valid value
            if(value === "") { delete storedData[key]; } 
            else { storedData[key] = value; }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(storedData));
            
            // CRITICAL FIX: Re-render to update the Weekly Stats column immediately
            renderCalendar(true); 
        }

        // --- CONVERTERS ---
        const c1_h = document.getElementById('c1_h');
        const c1_m = document.getElementById('c1_m');
        const c2_d = document.getElementById('c2_d');

        function updateMemory(val) {
            lastCalculatedDecimal = val;
            document.getElementById('globalMemory').innerText = val;
        }

        function calcTime() {
            const h = parseFloat(c1_h.value) || 0;
            const m = parseFloat(c1_m.value) || 0;
            const decimal = h + (m / 60);
            const fmt = Number.isInteger(decimal) ? decimal : decimal.toFixed(2);
            document.getElementById('res_decimal').innerText = fmt;
            updateMemory(fmt);
        }

        function calcDecimal() {
            const val = parseFloat(c2_d.value) || 0;
            const hours = Math.floor(val);
            const minutes = Math.round((val - hours) * 60);
            document.getElementById('res_time').innerText = (minutes === 60) ? `${hours + 1}h 0m` : `${hours}h ${minutes}m`;
            updateMemory(val);
        }

        [c1_h, c1_m].forEach(el => el.addEventListener('input', calcTime));
        c2_d.addEventListener('input', calcDecimal);

        // --- CALENDAR LOGIC ---

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDateKey(d) { return d.toISOString().split('T')[0]; }

        // Added preserveFocus param to allow seamless typing
        function renderCalendar(preserveFocus = false) {
            
            // Identify focused element before destroy
            let focusedKey = null;
            let focusedType = null; // 'main' or 'bonus'
            if (preserveFocus && document.activeElement) {
                if (document.activeElement.dataset.key) {
                    focusedKey = document.activeElement.dataset.key;
                    focusedType = document.activeElement.dataset.type;
                }
            }

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = ''; 

            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('monthLabel').innerText = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startDate = getMonday(firstDayOfMonth);
            const endDate = new Date(lastDayOfMonth);
            const endDay = endDate.getDay(); 
            if (endDay !== 0) {
                endDate.setDate(endDate.getDate() + (7 - endDay));
            }

            const todayKey = formatDateKey(new Date());

            let currentLoopDate = new Date(startDate);

            // Month Stats Accumulators
            let monthTotal = 0;
            let monthActiveDays = 0;

            while (currentLoopDate <= endDate) {
                
                let weekTotal = 0;
                let weekActiveDays = 0;
                const weekNodes = [];

                for (let i = 0; i < 7; i++) {
                    const dateKey = formatDateKey(currentLoopDate);
                    const bonusKey = `bonus_${dateKey}`;
                    
                    // Retrieve raw values (string) to check for emptiness
                    const rawVal = storedData[dateKey]; 
                    const rawBonus = storedData[bonusKey];

                    const val = rawVal !== undefined ? rawVal : '';
                    const bonusVal = rawBonus !== undefined ? rawBonus : '';
                    
                    const isToday = dateKey === todayKey;
                    const isCurrentMonth = currentLoopDate.getMonth() === month;

                    // Math
                    const numVal = parseFloat(val) || 0;
                    const numBonus = parseFloat(bonusVal) || 0;
                    const dailySum = numVal + numBonus;

                    weekTotal += dailySum;
                    
                    // Month Stats Logic
                    if(isCurrentMonth) {
                        monthTotal += dailySum;
                        if (rawVal !== undefined && rawVal !== "") monthActiveDays++;
                    }

                    // Week Stats Logic: Count active if Main Input is NOT empty (even if 0)
                    if (rawVal !== undefined && rawVal !== "") {
                        weekActiveDays++;
                    }

                    const baseOpacity = isCurrentMonth ? 'opacity-100' : 'opacity-40 hover:opacity-100 transition-opacity';
                    const cardBg = isToday ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-white dark:bg-slate-900';
                    const cardBorder = isToday ? 'border-blue-500 ring-1 ring-blue-500' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700';
                    const dayText = isToday ? 'text-blue-600 dark:text-blue-400 font-bold' : 'text-slate-500 dark:text-slate-400 font-medium';
                    const footerBg = 'bg-yellow-50 dark:bg-yellow-900/10';

                    const card = document.createElement('div');
                    card.className = `day-card border ${cardBorder} ${cardBg} ${baseOpacity}`;
                    card.innerHTML = `
                        <div class="day-header">
                            <span class="${dayText}">${currentLoopDate.getDate()}</span>
                            <button onclick="pasteValue('${dateKey}')" class="icon-btn text-slate-300 hover:text-blue-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                                <i data-lucide="arrow-down-to-line" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div class="day-body">
                            <input type="number" step="0.1" 
                                data-key="${dateKey}" data-type="main"
                                class="input-field bg-transparent border-none font-mono font-bold text-center text-xl w-full text-slate-900 dark:text-white" 
                                value="${val}" onchange="handleInputChange('${dateKey}', this.value)">
                        </div>
                        <div class="day-footer ${footerBg}">
                            <div class="flex items-center w-full px-1">
                                <button onclick="pasteValue('${bonusKey}')" class="icon-btn text-yellow-500 hover:text-yellow-700 hover:bg-yellow-100 dark:hover:bg-yellow-900/50 mr-1">
                                    <i data-lucide="plus" class="w-3 h-3"></i>
                                </button>
                                <input type="number" step="0.1" 
                                    data-key="${dateKey}" data-type="bonus"
                                    class="input-field bg-transparent border-none font-mono font-bold text-center text-xs w-full text-yellow-700 dark:text-yellow-500 placeholder-yellow-200" 
                                    value="${bonusVal}" placeholder="-" onchange="handleInputChange('${bonusKey}', this.value)">
                            </div>
                        </div>
                    `;
                    weekNodes.push(card);
                    currentLoopDate.setDate(currentLoopDate.getDate() + 1);
                }

                weekNodes.forEach(node => grid.appendChild(node));

                // 8th Column: Weekly Stats
                const weekAvg = weekActiveDays > 0 ? (weekTotal / weekActiveDays) : 0;
                
                const statCard = document.createElement('div');
                statCard.className = "stats-card bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700";
                statCard.innerHTML = `
                    <div class="flex flex-col gap-2 text-center">
                        <div>
                            <span class="text-[9px] uppercase font-bold text-slate-400 block">Wk Avg</span>
                            <span class="text-lg font-mono font-bold text-emerald-600 dark:text-emerald-400">${weekAvg.toFixed(2)}</span>
                        </div>
                        <div class="border-t border-slate-200 dark:border-slate-700 pt-1">
                            <span class="text-[9px] uppercase font-bold text-slate-400 block">Total</span>
                            <span class="text-sm font-mono font-bold text-slate-700 dark:text-slate-300">${weekTotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(statCard);
            }

            // Update Month Stats DOM
            const monthAvg = monthActiveDays > 0 ? (monthTotal / monthActiveDays) : 0;
            document.getElementById('monthTotal').innerText = monthTotal.toFixed(2);
            document.getElementById('monthAvg').innerText = monthAvg.toFixed(2);

            lucide.createIcons();

            // Restore Focus logic
            if (focusedKey) {
                // Find input with matching data attributes
                const selector = `input[data-key="${focusedKey}"][data-type="${focusedType}"]`;
                const el = document.querySelector(selector);
                if (el) {
                    el.focus();
                }
            }
        }

        function handleInputChange(key, value) { saveData(key, value); }
        function pasteValue(key) {
            if(lastCalculatedDecimal == 0) { showToast("Calculate first!"); return; }
            saveData(key, lastCalculatedDecimal);
            showToast("Pasted!");
        }

        function changeMonth(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            renderCalendar();
        }
        function goToToday() { viewDate = new Date(); renderCalendar(); }
        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg; toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
        }

        renderCalendar();
    </script>
</body>
</html>
