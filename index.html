<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOG Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' }
                    }
                }
            }
        }

        // Theme Init (Avoid FOUC)
        try {
            const userPref = localStorage.getItem('theme');
            const systemPref = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (userPref === 'dark' || (!userPref && systemPref)) { document.documentElement.classList.add('dark'); }
            else { document.documentElement.classList.remove('dark'); }
        } catch(e) { console.error(e); }

        window.toggleTheme = function() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
            else { html.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
        }
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        .input-field { transition: all 0.2s; }
        .input-field:focus { outline: none; }
        .btn-outline { transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .icon-btn { padding: 2px; border-radius: 4px; transition: all 0.2s; cursor: pointer; }
        
        /* Grid Layout: Dynamic based on JS */
        .calendar-grid {
            display: grid;
            /* Default fallback */
            grid-template-columns: repeat(8, minmax(100px, 1fr)); 
            gap: 0.5rem;
        }

        .day-card { border-radius: 0.375rem; overflow: hidden; display: flex; flex-direction: column; min-height: 100px; }
        .stats-card { border-radius: 0.375rem; display: flex; flex-direction: column; justify-content: center; padding: 0.5rem; min-height: 100px; }

        .day-header { padding: 4px 6px; display: flex; justify-content: space-between; items-center; font-size: 0.75rem; }
        .day-body { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2px; }
        .day-footer { height: 24px; display: flex; align-items: center; justify-content: center; border-top-width: 1px; }

        #toast { visibility: hidden; min-width: 200px; text-align: center; border-radius: 6px; padding: 10px; position: fixed; z-index: 50; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 13px; font-weight: 500; opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }

        /* Auth Styles */
        .main-gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .main-gradient-box {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
        }
        .screen-transition {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        /* .hidden { display: none !important; } - Removed to allow Tailwind utilities to work */
        
        @media (max-width: 1024px) {
            .scroll-container { overflow-x: auto; padding-bottom: 10px; }
            .calendar-grid { min-width: 900px; } /* Ensures grid doesn't break on mobile */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen p-4 flex flex-col items-center">

    <!-- =========== AUTHENTICATION SCREEN =========== -->
    <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-50 screen-transition">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-2xl shadow-xl mx-4">
                <div class="text-center mb-8">
                    <div class="flex justify-center items-baseline gap-2">
                        <!-- <img src="/assets/logo_t.png" alt="Logo" class="w-12 h-12 relative top-1" onerror="this.style.display='none'"> -->
                        <div class="pb-2">
                            <h1 class="text-5xl font-bold main-gradient-text pb-2">TOG Tracker</h1>
                        </div>
                    </div>
                    <p class="text-gray-600">Track your Time on Ground effectively.</p>
                </div>

                <div class="space-y-4">
                    <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-3 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 transition text-gray-900">
                    <div class="relative">
                        <input id="password-input" type="password" placeholder="Password" class="w-full px-4 py-3 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 transition text-gray-900">
                        <button id="password-toggle" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-600">
                            <i id="eye-open-icon" class="fas fa-eye"></i>
                            <i id="eye-closed-icon" class="fas fa-eye-slash hidden"></i>
                        </button>
                    </div>
                    <div class="flex justify-end items-center">
                        <a id="forgot-password-link" href="#" class="text-sm text-blue-600 hover:underline">Forgot Password?</a>
                    </div>
                </div>

                <div id="auth-error-message" class="text-red-600 text-sm mt-4 text-center h-4"></div>

                <div class="flex items-center gap-2 mt-4">
                    <button id="signin-btn" class="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition main-gradient-box flex justify-center items-center h-12">
                        <span class="button-text">Sign In</span>
                        <i class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                    <button id="signup-btn" class="w-full py-3 text-gray-700 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300 transition flex justify-center items-center h-12">
                        <span class="button-text">Sign Up</span>
                        <i class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                </div>

                <div class="flex items-center my-6">
                    <hr class="flex-grow border-t border-gray-300">
                    <span class="px-3 text-gray-500 text-sm">OR</span>
                    <hr class="flex-grow border-t border-gray-300">
                </div>

                <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 py-3 border border-gray-300 rounded-lg hover:bg-gray-100 transition h-12">
                    <img src="/assets/google.webp" alt="Google Icon" class="w-5 h-5 button-icon" onerror="this.style.display='none'; this.nextElementSibling.innerText='Continue with Google';">
                    <span class="button-text text-gray-700">Continue with Google</span>
                    <i class="fas fa-spinner fa-spin hidden"></i>
                </button>

                <button id="offline-btn" class="w-full text-center mt-3 py-3 text-gray-700 bg-gray-100 font-semibold rounded-lg hover:bg-gray-200 transition">
                    Continue as Guest
                    <span class="block text-xs font-normal text-gray-600">(Saves data only on this device)</span>
                </button>

                <div class="text-center mt-8">
                    <a href="mailto:arunthomas04042001@gmail.com" class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-envelope"></i>
                        Contact Developer
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="w-full max-w-[1400px] space-y-6 hidden">
        
        <div class="flex flex-row items-center justify-between relative z-20">
            <div>
                <h1 class="text-xl font-bold tracking-tight">TOG Tracker</h1>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="bg-white dark:bg-slate-900 px-3 py-1.5 rounded-md border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-2 transition-colors">
                    <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Memory</span>
                    <span id="globalMemory" class="font-mono font-bold text-blue-600 dark:text-blue-400 text-sm">0.0</span>
                </div>
                <button onclick="toggleTheme()" class="p-2 rounded-md bg-white border border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-900 dark:border-slate-800 dark:text-slate-400 dark:hover:bg-slate-800 transition-colors">
                    <!-- Sun Icon (Show in Dark Mode) -->
                    <svg class="w-4 h-4 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <!-- Moon Icon (Show in Light Mode) -->
                    <svg class="w-4 h-4 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>

                <!-- User Avatar & Menu -->
                <div class="relative" id="user-menu-container">
                    <button id="user-avatar-btn" class="w-9 h-9 rounded-full flex items-center justify-center shadow-sm border border-slate-200 dark:border-slate-700 transition-transform hover:scale-105 overflow-hidden">
                        <!-- Content injected by JS -->
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="user-dropdown" class="absolute top-full right-0 mt-2 w-48 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl shadow-xl transform origin-top-right transition-all duration-200 opacity-0 scale-95 pointer-events-none z-50">
                        <div class="p-2">
                            <div class="px-3 py-2 border-b border-slate-100 dark:border-slate-800 mb-1">
                                <p id="menu-user-email" class="text-xs text-slate-500 dark:text-slate-400 truncate">Guest</p>
                            </div>
                            <button id="logout-btn" class="w-full text-left px-3 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg flex items-center gap-2 transition-colors">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                <span>Log Out</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-white border border-slate-200 dark:bg-slate-900 dark:border-slate-800 p-4 rounded-xl flex items-center gap-4 shadow-sm">
                <div class="min-w-[90px] text-xs font-bold uppercase text-slate-400">TIME TO TOG</div>
                <input type="number" id="c1_h" class="input-field w-16 bg-slate-50 border border-slate-200 text-slate-900 rounded p-1 text-center dark:bg-slate-950 dark:border-slate-700 dark:text-white" placeholder="H">
                <span class="text-slate-300">:</span>
                <input type="number" id="c1_m" class="input-field w-16 bg-slate-50 border border-slate-200 text-slate-900 rounded p-1 text-center dark:bg-slate-950 dark:border-slate-700 dark:text-white" placeholder="M">
                <div class="flex-1 text-right">
                    <span id="res_decimal" class="font-mono font-bold text-lg text-blue-600 dark:text-blue-400">0.0</span>
                </div>
            </div>

            <div class="bg-white border border-slate-200 dark:bg-slate-900 dark:border-slate-800 p-4 rounded-xl flex items-center gap-4 shadow-sm">
                <div class="min-w-[90px] text-xs font-bold uppercase text-slate-400">TOG TO TIME</div>
                <input type="number" id="c2_d" class="input-field w-24 bg-slate-50 border border-slate-200 text-slate-900 rounded p-1 text-center dark:bg-slate-950 dark:border-slate-700 dark:text-white" placeholder="5.2">
                <div class="flex-1 text-right">
                    <span id="res_time" class="font-mono font-bold text-lg text-emerald-600 dark:text-emerald-400">0h 0m</span>
                </div>
            </div>
        </div>

        <div class="bg-white border border-slate-200 dark:bg-slate-900 dark:border-slate-800 p-4 md:p-6 rounded-xl shadow-sm">
            
            <div class="flex justify-center items-center gap-4 mb-6 relative">
                <button onclick="changeMonth(-1)" class="btn-outline border-slate-200 text-slate-700 bg-white hover:bg-slate-50 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 px-2 h-9"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                
                <div class="text-center w-48">
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white" id="monthLabel">...</h2>
                    <button onclick="goToToday()" class="text-[10px] font-bold uppercase text-blue-500 hover:text-blue-700 mt-0.5 tracking-wider">Jump to Today</button>
                </div>

                <button onclick="changeMonth(1)" class="btn-outline border-slate-200 text-slate-700 bg-white hover:bg-slate-50 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 px-2 h-9"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 border-t border-b border-slate-100 dark:border-slate-800 py-3">
                
                <div class="flex flex-col items-center md:items-start gap-1">
                    <span class="text-[10px] uppercase font-bold text-slate-400">Visible Days</span>
                    <div id="dayToggles" class="flex gap-1">
                        </div>
                </div>

                <div class="flex gap-6 items-center bg-slate-50 dark:bg-slate-800/50 px-5 py-2 rounded-lg border border-slate-100 dark:border-slate-800">
                    <div class="text-center md:text-right">
                        <span class="block text-[10px] uppercase font-bold text-slate-400">Total (View)</span>
                        <span id="monthTotal" class="text-xl font-bold text-slate-900 dark:text-white leading-none">0.0</span>
                    </div>
                    <div class="w-px h-8 bg-slate-200 dark:bg-slate-700"></div>
                    <div class="text-center md:text-right">
                        <span class="block text-[10px] uppercase font-bold text-slate-400">Avg (Active)</span>
                        <span id="monthAvg" class="text-xl font-bold text-blue-600 dark:text-blue-400 leading-none">0.0</span>
                    </div>
                </div>
            </div>

            <div class="scroll-container">
                <div class="calendar-grid mb-2" id="headerRow">
                    </div>

                <div class="calendar-grid" id="calendarGrid">
                    </div>
            </div>

        </div>
    </div>

    <div id="toast" class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-lg">Notification</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAYrDqjFtaSKcJXeAvcvvmvdB05ucagB1s",
            authDomain: "togtrackeraoh.firebaseapp.com",
            projectId: "togtrackeraoh",
            storageBucket: "togtrackeraoh.firebasestorage.app",
            messagingSenderId: "319056112034",
            appId: "1:319056112034:web:9c0e06d89a752c0d5faafb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH LOGIC ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const authError = document.getElementById('auth-error-message');

        // --- AVATAR LOGIC ---
        function getAvatar(user) {
            if (!user) {
                // Guest - Simple user icon SVG
                return `<div class="bg-gray-200 dark:bg-slate-800 w-full h-full flex items-center justify-center text-slate-500 dark:text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>`;
            }

            const email = user.email || "?";
            const letter = email.charAt(0).toUpperCase();

            // Generate deterministic color based on UID
            const uid = user.uid;
            let hash = 0;
            for (let i = 0; i < uid.length; i++) {
                hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c1 = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            const c2 = ((hash >> 4) & 0x00FFFFFF).toString(16).toUpperCase();
            const color1 = "#" + "00000".substring(0, 6 - c1.length) + c1;
            const color2 = "#" + "00000".substring(0, 6 - c2.length) + c2;

            return `<div style="background: linear-gradient(135deg, ${color1}, ${color2});" class="w-full h-full flex items-center justify-center text-white font-bold text-sm shadow-inner">
                ${letter}
            </div>`;
        }

        function renderHeader(user) {
            const avatarBtn = document.getElementById('user-avatar-btn');
            const emailLabel = document.getElementById('menu-user-email');

            if(avatarBtn) avatarBtn.innerHTML = getAvatar(user);
            if(emailLabel) emailLabel.innerText = user ? user.email : "Guest Session";
        }

        // Dropdown Toggle Logic
        function initAvatarDropdown() {
            const menuContainer = document.getElementById('user-menu-container');
            const dropdown = document.getElementById('user-dropdown');
            const avatarBtn = document.getElementById('user-avatar-btn');

            if (avatarBtn && dropdown && menuContainer) {
                // Toggle on click
                avatarBtn.onclick = (e) => {
                    e.stopPropagation();
                    const isClosed = dropdown.classList.contains('opacity-0');
                    if(isClosed) {
                        dropdown.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                    } else {
                        dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                    }
                };

                // Close when clicking outside
                document.onclick = (e) => {
                    if(!menuContainer.contains(e.target)) {
                        dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                    }
                };
            }
        }

        function showApp() {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            renderCalendar();
            // Initialize dropdown listeners once app is shown or scripts loaded
            initAvatarDropdown();
        }

        function showAuth() {
            appContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
        }

        function toggleLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if(!btn) return;
            const text = btn.querySelector('.button-text');
            const spinner = btn.querySelector('.fa-spinner');
            if(isLoading) {
                if(text) text.classList.add('hidden');
                if(spinner) spinner.classList.remove('hidden');
                btn.disabled = true;
            } else {
                if(text) text.classList.remove('hidden');
                if(spinner) spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function showError(msg) {
            authError.innerText = msg;
            setTimeout(() => authError.innerText = '', 5000);
        }

        // Event Listeners
        document.getElementById('signin-btn').addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if(!email || !password) { showError('Please enter email and password.'); return; }
            toggleLoading('signin-btn', true);
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    toggleLoading('signin-btn', false);
                    showError(error.message);
                });
        });

        document.getElementById('signup-btn').addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if(!email || !password) { showError('Please enter email and password.'); return; }
            toggleLoading('signup-btn', true);
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    toggleLoading('signup-btn', false);
                    showError(error.message);
                });
        });

        document.getElementById('google-signin-btn').addEventListener('click', () => {
            toggleLoading('google-signin-btn', true);
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch(error => {
                    toggleLoading('google-signin-btn', false);
                    showError(error.message);
                });
        });

        document.getElementById('offline-btn').addEventListener('click', () => {
            showApp();
            renderHeader(null);
        });

        document.getElementById('password-toggle').addEventListener('click', () => {
            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;
            document.getElementById('eye-open-icon').classList.toggle('hidden');
            document.getElementById('eye-closed-icon').classList.toggle('hidden');
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (auth.currentUser) {
                localStorage.removeItem(STORAGE_KEY);
                await signOut(auth);
            }
            window.location.reload();
        });

        // Sync Logic
        async function syncData(user) {
            try {
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    storedData = { ...storedData, ...cloudData };
                    if (storedData._dayVisibility) {
                        dayVisibility = storedData._dayVisibility;
                    }
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(storedData));
                    renderCalendar();
                } else {
                    if (Object.keys(storedData).length > 0) {
                        await setDoc(userRef, storedData, { merge: true });
                    }
                }
            } catch (e) {
                console.error("Sync error:", e);
                showToast("Sync Error: " + e.message);
            }
        }

        onAuthStateChanged(auth, (user) => {
            toggleLoading('signin-btn', false);
            toggleLoading('signup-btn', false);
            toggleLoading('google-signin-btn', false);

            if (user) {
                showApp();
                renderHeader(user);
                syncData(user);
            }
            // If no user, stay on auth screen.
        });

        // --- ORIGINAL APP LOGIC ---
        
        lucide.createIcons();

        // --- VARS & STORAGE ---
        let viewDate = new Date(); 
        let lastCalculatedDecimal = 0.0;
        const STORAGE_KEY = 'tog_tracker_v11'; 
        let storedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let dayVisibility = storedData._dayVisibility || [true, true, true, true, true, true, true];

        async function saveData(key, value) {
            if(value === "") { delete storedData[key]; } 
            else { storedData[key] = value; }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(storedData));
            renderCalendar(true); 

            const user = auth.currentUser;
            if(user) {
                const userRef = doc(db, "users", user.uid);
                const payload = {};
                if (value === "") payload[key] = deleteField();
                else payload[key] = value;
                try {
                    await setDoc(userRef, payload, { merge: true });
                } catch(e) { console.error("Save sync error", e); }
            }
        }

        // --- CONVERTERS ---
        const c1_h = document.getElementById('c1_h');
        const c1_m = document.getElementById('c1_m');
        const c2_d = document.getElementById('c2_d');

        function updateMemory(val) {
            lastCalculatedDecimal = val;
            document.getElementById('globalMemory').innerText = val;
        }

        function calcTime() {
            const h = parseFloat(c1_h.value) || 0;
            const m = parseFloat(c1_m.value) || 0;
            const decimal = h + (m / 60);
            const fmt = Number.isInteger(decimal) ? decimal : decimal.toFixed(2);
            document.getElementById('res_decimal').innerText = fmt;
            updateMemory(fmt);
        }

        function calcDecimal() {
            const val = parseFloat(c2_d.value) || 0;
            const hours = Math.floor(val);
            const minutes = Math.round((val - hours) * 60);
            document.getElementById('res_time').innerText = (minutes === 60) ? `${hours + 1}h 0m` : `${hours}h ${minutes}m`;
            updateMemory(val);
        }

        if(c1_h) [c1_h, c1_m].forEach(el => el.addEventListener('input', calcTime));
        if(c2_d) c2_d.addEventListener('input', calcDecimal);

        // --- VISIBILITY ---
        window.toggleDay = function(index) {
            dayVisibility[index] = !dayVisibility[index];
            saveData('_dayVisibility', dayVisibility);
        }

        // --- CALENDAR LOGIC ---
        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDateKey(d) { return d.toISOString().split('T')[0]; }

        function renderCalendar(preserveFocus = false) {
            let focusedKey = null;
            let focusedType = null;
            if (preserveFocus && document.activeElement && document.activeElement.dataset.key) {
                focusedKey = document.activeElement.dataset.key;
                focusedType = document.activeElement.dataset.type;
            }

            // 1. Render Toggles
            const toggleContainer = document.getElementById('dayToggles');
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            toggleContainer.innerHTML = '';
            dayNames.forEach((name, idx) => {
                const isVisible = dayVisibility[idx];
                const btn = document.createElement('button');
                const activeClass = isVisible 
                    ? "bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/40 dark:text-blue-300 dark:border-blue-800" 
                    : "bg-slate-50 text-slate-300 border-slate-100 dark:bg-slate-900 dark:text-slate-700 dark:border-slate-800";
                
                btn.className = `flex items-center justify-center w-8 h-8 rounded text-[10px] font-bold border transition-colors ${activeClass}`;
                btn.onclick = () => window.toggleDay(idx);
                // First letter only
                btn.innerText = name.charAt(0);
                btn.title = isVisible ? `Hide ${name}` : `Show ${name}`;
                toggleContainer.appendChild(btn);
            });

            // 2. Adjust Grid
            const visibleCount = dayVisibility.filter(Boolean).length;
            const gridCols = visibleCount + 1; 
            const headerRow = document.getElementById('headerRow');
            const grid = document.getElementById('calendarGrid');
            const style = `grid-template-columns: repeat(${gridCols}, minmax(100px, 1fr));`;
            headerRow.style.cssText = style;
            grid.style.cssText = style;

            // 3. Headers
            headerRow.innerHTML = '';
            dayNames.forEach((name, idx) => {
                if(!dayVisibility[idx]) return; 
                const div = document.createElement('div');
                div.className = "text-center text-xs font-bold text-slate-400 uppercase py-1";
                div.innerText = name;
                headerRow.appendChild(div);
            });
            const wkDiv = document.createElement('div');
            wkDiv.className = "text-center text-xs font-bold text-emerald-500 uppercase py-1 border-l border-slate-100 dark:border-slate-800";
            wkDiv.innerText = "Weekly";
            headerRow.appendChild(wkDiv);

            // 4. Grid Body
            grid.innerHTML = ''; 
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('monthLabel').innerText = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startDate = getMonday(firstDayOfMonth);
            const endDate = new Date(lastDayOfMonth);
            const endDay = endDate.getDay(); 
            if (endDay !== 0) endDate.setDate(endDate.getDate() + (7 - endDay));

            const todayKey = formatDateKey(new Date());

            let currentLoopDate = new Date(startDate);
            let monthTotal = 0;
            let monthActiveDays = 0;

            while (currentLoopDate <= endDate) {
                
                let weekTotal = 0;
                let weekActiveDays = 0;
                const weekNodes = [];

                for (let i = 0; i < 7; i++) {
                    const dateKey = formatDateKey(currentLoopDate);
                    const bonusKey = `bonus_${dateKey}`;
                    const rawVal = storedData[dateKey]; 
                    const rawBonus = storedData[bonusKey];
                    const val = rawVal !== undefined ? rawVal : '';
                    const bonusVal = rawBonus !== undefined ? rawBonus : '';
                    
                    const isToday = dateKey === todayKey;
                    const isCurrentMonth = currentLoopDate.getMonth() === month;
                    const numVal = parseFloat(val) || 0;
                    const numBonus = parseFloat(bonusVal) || 0;
                    const dailySum = numVal + numBonus;

                    if (dayVisibility[i]) {
                        weekTotal += dailySum;
                        
                        if(isCurrentMonth) {
                            monthTotal += dailySum;
                            if (rawVal !== undefined && rawVal !== "") monthActiveDays++;
                        }
                        if (rawVal !== undefined && rawVal !== "") {
                            weekActiveDays++;
                        }

                        const baseOpacity = isCurrentMonth ? 'opacity-100' : 'opacity-40 hover:opacity-100 transition-opacity';
                        const cardBg = isToday ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-white dark:bg-slate-900';
                        const cardBorder = isToday ? 'border-blue-500 ring-1 ring-blue-500' : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700';
                        const dayText = isToday ? 'text-blue-600 dark:text-blue-400 font-bold' : 'text-slate-500 dark:text-slate-400 font-medium';
                        const footerBg = 'bg-yellow-50 dark:bg-yellow-900/10';

                        const card = document.createElement('div');
                        card.className = `day-card border ${cardBorder} ${cardBg} ${baseOpacity}`;
                        card.innerHTML = `
                            <div class="day-header">
                                <span class="${dayText}">${currentLoopDate.getDate()}</span>
                                <button onclick="window.pasteValue('${dateKey}')" class="icon-btn text-slate-300 hover:text-blue-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                                    <i data-lucide="arrow-down-to-line" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <div class="day-body">
                                <input type="number" step="0.1" 
                                    data-key="${dateKey}" data-type="main"
                                    class="input-field bg-transparent border-none font-mono font-bold text-center text-xl w-full text-slate-900 dark:text-white" 
                                    value="${val}" onchange="window.handleInputChange('${dateKey}', this.value)">
                            </div>
                            <div class="day-footer ${footerBg}">
                                <div class="flex items-center w-full px-1">
                                    <button onclick="window.pasteValue('${bonusKey}')" class="icon-btn text-yellow-500 hover:text-yellow-700 hover:bg-yellow-100 dark:hover:bg-yellow-900/50 mr-1">
                                        <i data-lucide="plus" class="w-3 h-3"></i>
                                    </button>
                                    <input type="number" step="0.1" 
                                        data-key="${dateKey}" data-type="bonus"
                                        class="input-field bg-transparent border-none font-mono font-bold text-center text-xs w-full text-yellow-700 dark:text-yellow-500 placeholder-yellow-200" 
                                        value="${bonusVal}" placeholder="-" onchange="window.handleInputChange('${bonusKey}', this.value)">
                                </div>
                            </div>
                        `;
                        weekNodes.push(card);
                    }
                    currentLoopDate.setDate(currentLoopDate.getDate() + 1);
                }

                weekNodes.forEach(node => grid.appendChild(node));

                // Weekly Stats
                const weekAvg = weekActiveDays > 0 ? (weekTotal / weekActiveDays) : 0;
                const statCard = document.createElement('div');
                statCard.className = "stats-card bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700";
                statCard.innerHTML = `
                    <div class="flex flex-col gap-2 text-center">
                        <div>
                            <span class="text-[9px] uppercase font-bold text-slate-400 block">Wk Avg</span>
                            <span class="text-lg font-mono font-bold text-emerald-600 dark:text-emerald-400">${weekAvg.toFixed(2)}</span>
                        </div>
                        <div class="border-t border-slate-200 dark:border-slate-700 pt-1">
                            <span class="text-[9px] uppercase font-bold text-slate-400 block">Total</span>
                            <span class="text-sm font-mono font-bold text-slate-700 dark:text-slate-300">${weekTotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(statCard);
            }

            // Month Stats
            const monthAvg = monthActiveDays > 0 ? (monthTotal / monthActiveDays) : 0;
            document.getElementById('monthTotal').innerText = monthTotal.toFixed(2);
            document.getElementById('monthAvg').innerText = monthAvg.toFixed(2);

            lucide.createIcons();
            if (focusedKey) {
                const el = document.querySelector(`input[data-key="${focusedKey}"][data-type="${focusedType}"]`);
                if (el) el.focus();
            }
        }

        window.handleInputChange = function(key, value) { saveData(key, value); }
        window.pasteValue = function(key) {
            if(lastCalculatedDecimal == 0) { showToast("Calculate first!"); return; }
            saveData(key, lastCalculatedDecimal);
            showToast("Pasted!");
        }
        window.changeMonth = function(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            renderCalendar();
        }
        window.goToToday = function() { viewDate = new Date(); renderCalendar(); }
        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg; toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
        }
        window.showToast = showToast;

        renderCalendar();
    </script>
    </div>
    <footer id="main-footer" class="mt-10 flex justify-center items-center gap-10 relative z-10">
        <a href="mailto:arunthomas04042001@gmail.com" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" aria-label="Contact Developer" data-i18n-aria-label="reachOut">
            <i class="fas fa-envelope text-base"></i>
            <span data-i18n="reachOut" class="hidden sm:inline">Contact Developer</span>
        </a>
    </footer>
</div>
</body>
</html>
